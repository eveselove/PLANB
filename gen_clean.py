import pandas as pd
import numpy as np
import pickle
import os


import panel as pn
pn.extension('tabulator')

import pandas as pd

# ID —Ç–∞–±–ª–∏—Ü—ã –∏–∑ —Å—Å—ã–ª–∫–∏
sheet_id = '1q_hU5hQJ2aQXadGKJak2BY2DWltGTrhpi_7UyRVbXVM'
# –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ CSV
url = f'https://docs.google.com/spreadsheets/d/{sheet_id}/export?format=csv'

# –ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ DataFrame
df = pd.read_csv(url)

# –í—ã–≤–æ–¥ –ø–µ—Ä–≤—ã—Ö 5 —Å—Ç—Ä–æ–∫ —Ç–∞–±–ª–∏—Ü—ã
print('UI Skipped: ' + str(df.head()))

# @title –ü–ª–∞–Ω 2026
# –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ (unpivot) —Ç–∞–±–ª–∏—Ü—ã: –º–µ—Å—è—Ü—ã –∏–∑ –∫–æ–ª–æ–Ω–æ–∫ –ø–µ—Ä–µ–Ω–æ—Å–∏–º –≤ —Å—Ç—Ä–æ–∫–∏
# –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤–æ–µ –∏–º—è –∫–æ–ª–æ–Ω–∫–∏ '–§–∏–ª–∏–∞–ª'
df_plan_2026 = df.melt(id_vars=['–§–∏–ª–∏–∞–ª'], var_name='–ú–µ—Å—è—Ü', value_name='–ü–ª–∞–Ω')

# –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ—Ä—è–¥–∫–∞ —Å—Ç–æ–ª–±—Ü–æ–≤: –ú–µ—Å—è—Ü, –§–∏–ª–∏–∞–ª, –ü–ª–∞–Ω
df_plan_2026 = df_plan_2026[['–ú–µ—Å—è—Ü', '–§–∏–ª–∏–∞–ª', '–ü–ª–∞–Ω']]

# –î–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º –∫–æ–¥–æ–º
df_melted = df_plan_2026

# –í—ã–≤–æ–¥ –ø–µ—Ä–≤—ã—Ö —Å—Ç—Ä–æ–∫ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã
print('UI Skipped: ' + str(df_plan_2026.head()))

# @title –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –ø—Ä–æ–¥–∞–∂ –í–ª–∞–¥–∏–º–∏—Ä
import pandas as pd

sheet_id_3 = '1Uh_5wP8MFJUgaHm_JLJkwQvzKWTyWqQW5LOr3p29h_o'
gid_3 = '129997454'
url_3 = f'https://docs.google.com/spreadsheets/d/{sheet_id_3}/export?format=csv&gid={gid_3}'

df_sales_detail = pd.read_csv(url_3)

# –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ (melt) —Ç–∞–±–ª–∏—Ü—ã: –º–µ—Å—è—Ü—ã –∏–∑ –∫–æ–ª–æ–Ω–æ–∫ –ø–µ—Ä–µ–Ω–æ—Å–∏–º –≤ —Å—Ç—Ä–æ–∫–∏
df_sales_detail = df_sales_detail.melt(
    id_vars=['–§–∏–ª–∏–∞–ª', '–û—Ç–¥–µ–ª', '–ö–æ–¥ —ç–∫—Å–ø–µ—Ä—Ç–∞', '–§–∏–ª–∏–∞–ª –ö–æ—Ä—Ä'],
    var_name='–ú–µ—Å—è—Ü',
    value_name='–í—ã—Ä—É—á–∫–∞'
)

# –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤—ã—Ä—É—á–∫–∏ –≤ —á–∏—Å–ª–æ (–æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—è—Ç—ã—Ö –∏ –ø—Ä–æ–±–µ–ª–æ–≤)
df_sales_detail['–í—ã—Ä—É—á–∫–∞'] = df_sales_detail['–í—ã—Ä—É—á–∫–∞'].astype(str).str.replace(r'\s+', '', regex=True).str.replace(',', '.')
df_sales_detail['–í—ã—Ä—É—á–∫–∞'] = pd.to_numeric(df_sales_detail['–í—ã—Ä—É—á–∫–∞'], errors='coerce')

# –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫ —Å NaN –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
df_sales_detail = df_sales_detail.dropna(subset=['–í—ã—Ä—É—á–∫–∞'])

# –°–æ–∑–¥–∞–Ω–∏–µ —Å–≤–æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã (–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –∏ —Å—É–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ)
df_sales_summary = df_sales_detail.groupby(
    ['–§–∏–ª–∏–∞–ª', '–û—Ç–¥–µ–ª', '–§–∏–ª–∏–∞–ª –ö–æ—Ä—Ä', '–ú–µ—Å—è—Ü'], as_index=False
)['–í—ã—Ä—É—á–∫–∞'].sum()

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏ –ì–æ–¥
df_sales_summary['–ì–æ–¥'] = 2025

print("–°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ (–ø–µ—Ä–≤—ã–µ 5 —Å—Ç—Ä–æ–∫):")
print('UI Skipped: ' + str(df_sales_summary.head()))

import pandas as pd
import numpy as np

# 1. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–æ–¥–∞–∂–∞—Ö
# ID —Ç–∞–±–ª–∏—Ü—ã –ø—Ä–æ–¥–∞–∂
sales_sheet_id = '1Uh_5wP8MFJUgaHm_JLJkwQvzKWTyWqQW5LOr3p29h_o'
# –°—Å—ã–ª–∫–∞ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
sales_url = f'https://docs.google.com/spreadsheets/d/{sales_sheet_id}/export?format=csv'

df_sales_2023_2025 = pd.read_csv(sales_url)

print(f"–ü–æ—Å–ª–µ pd.read_csv (–∏—Å—Ö–æ–¥–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫): {len(df_sales_2023_2025)}")

# 2. –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ '–í—ã—Ä—É—á–∫–∞' –≤ —á–∏—Å–ª–æ–≤–æ–π —Ç–∏–ø
# –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–±–µ–ª–æ–≤ (—Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–π —Ç—ã—Å—è—á) –∏ –∑–∞–º–µ–Ω–∞ –∑–∞–ø—è—Ç—ã—Ö –Ω–∞ —Ç–æ—á–∫–∏
df_sales_2023_2025['–í—ã—Ä—É—á–∫–∞'] = df_sales_2023_2025['–í—ã—Ä—É—á–∫–∞'].astype(str).str.replace(r'\s+', '', regex=True).str.replace(',', '.')
df_sales_2023_2025['–í—ã—Ä—É—á–∫–∞'] = pd.to_numeric(df_sales_2023_2025['–í—ã—Ä—É—á–∫–∞'], errors='coerce')

# –û—á–∏—Å—Ç–∫–∞ —Å—Ç—Ä–æ–∫–æ–≤—ã—Ö –∫–æ–ª–æ–Ω–æ–∫ –æ—Ç –ª–∏—à–Ω–∏—Ö –ø—Ä–æ–±–µ–ª–æ–≤
df_sales_2023_2025['–§–∏–ª–∏–∞–ª'] = df_sales_2023_2025['–§–∏–ª–∏–∞–ª'].astype(str).str.strip()
df_sales_2023_2025['–û—Ç–¥–µ–ª'] = df_sales_2023_2025['–û—Ç–¥–µ–ª'].astype(str).str.strip()
df_sales_2023_2025['–ú–µ—Å—è—Ü'] = df_sales_2023_2025['–ú–µ—Å—è—Ü'].astype(str).str.strip()

# --- –£–î–ê–õ–ï–ù–ò–ï –î–£–ë–õ–ò–ö–ê–¢–û–í ---
# –£–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–≤–ø–∞–¥–∞—é—Ç –ø–æ –∏–∑–º–µ—Ä–µ–Ω–∏—è–º –ò —Å—É–º–º–µ –≤—ã—Ä—É—á–∫–∏
before_dedup = len(df_sales_2023_2025)
df_sales_2023_2025.drop_duplicates(subset=['–§–∏–ª–∏–∞–ª', '–û—Ç–¥–µ–ª', '–ì–æ–¥', '–ú–µ—Å—è—Ü', '–í—ã—Ä—É—á–∫–∞'], inplace=True)
after_dedup = len(df_sales_2023_2025)
print(f"–£–¥–∞–ª–µ–Ω–æ –ø–æ–ª–Ω—ã—Ö –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ (—Å —É—á–µ—Ç–æ–º –≤—ã—Ä—É—á–∫–∏): {before_dedup - after_dedup}")

# –ê–≥—Ä–µ–≥–∞—Ü–∏—è –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –∑–∞–ø–∏—Å–µ–π: –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å—Ç–æ–ª–±—Ü–∞–º –∏ —Å—É–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ –í—ã—Ä—É—á–∫–∏ –∏ –ß–µ–∫–æ–≤
# –≠—Ç–æ –æ–±—ä–µ–¥–∏–Ω–∏—Ç —Ä–∞–∑—Ä–æ–∑–Ω–µ–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (–µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å), –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —è–≤–ª—è—é—Ç—Å—è –ø–æ–ª–Ω—ã–º–∏ –¥—É–±–ª—è–º–∏
df_sales_2023_2025 = df_sales_2023_2025.groupby(
    ['–§–∏–ª–∏–∞–ª', '–û—Ç–¥–µ–ª', '–ì–æ–¥', '–ú–µ—Å—è—Ü'], as_index=False
).agg({'–í—ã—Ä—É—á–∫–∞': 'sum', '–ß–µ–∫–∏': 'sum'})

print(f"–ü–æ—Å–ª–µ groupby –∏ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ (–∏—Ç–æ–≥–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫): {len(df_sales_2023_2025)}")

# 3. –°–æ–∑–¥–∞–Ω–∏–µ DataFrame –¥–ª—è –≤—ã—á–µ—Ç–æ–≤
# –ê–≥—Ä–µ–≥–∏—Ä—É–µ–º df_sales_summary –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º deductions, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –ø—Ä–∏ —Å–ª–∏—è–Ω–∏–∏
deductions = df_sales_summary.groupby(['–§–∏–ª–∏–∞–ª', '–û—Ç–¥–µ–ª', '–ú–µ—Å—è—Ü', '–ì–æ–¥'])['–í—ã—Ä—É—á–∫–∞'].sum().reset_index().rename(columns={'–í—ã—Ä—É—á–∫–∞': 'Deduction'})

# 4. –°–æ–∑–¥–∞–Ω–∏–µ DataFrame –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏–π
# –ê–≥—Ä–µ–≥–∏—Ä—É–µ–º df_sales_summary –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º additions, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –ø—Ä–∏ —Å–ª–∏—è–Ω–∏–∏
# –í–ê–ñ–ù–û: –í—ã–±–∏—Ä–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ–º, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç–æ–ª–±—Ü–∞ '–§–∏–ª–∏–∞–ª'
additions_temp = df_sales_summary[['–§–∏–ª–∏–∞–ª –ö–æ—Ä—Ä', '–û—Ç–¥–µ–ª', '–ú–µ—Å—è—Ü', '–ì–æ–¥', '–í—ã—Ä—É—á–∫–∞']].rename(columns={'–§–∏–ª–∏–∞–ª –ö–æ—Ä—Ä': '–§–∏–ª–∏–∞–ª'})
additions = additions_temp.groupby(['–§–∏–ª–∏–∞–ª', '–û—Ç–¥–µ–ª', '–ú–µ—Å—è—Ü', '–ì–æ–¥'])['–í—ã—Ä—É—á–∫–∞'].sum().reset_index().rename(columns={'–í—ã—Ä—É—á–∫–∞': 'Addition'})

# 5. –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤—ã—á–µ—Ç–æ–≤
df_sales_2023_2025 = pd.merge(df_sales_2023_2025, deductions, on=['–§–∏–ª–∏–∞–ª', '–û—Ç–¥–µ–ª', '–ú–µ—Å—è—Ü', '–ì–æ–¥'], how='left')
df_sales_2023_2025['–í—ã—Ä—É—á–∫–∞'] = df_sales_2023_2025['–í—ã—Ä—É—á–∫–∞'] - df_sales_2023_2025['Deduction'].fillna(0)
df_sales_2023_2025.drop(columns=['Deduction'], inplace=True)

# 6. –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–π
df_sales_2023_2025 = pd.merge(df_sales_2023_2025, additions, on=['–§–∏–ª–∏–∞–ª', '–û—Ç–¥–µ–ª', '–ú–µ—Å—è—Ü', '–ì–æ–¥'], how='left')
df_sales_2023_2025['–í—ã—Ä—É—á–∫–∞'] = df_sales_2023_2025['–í—ã—Ä—É—á–∫–∞'] + df_sales_2023_2025['Addition'].fillna(0)
df_sales_2023_2025.drop(columns=['Addition'], inplace=True)

# 7. –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ –∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ
df_sales_2023_2025['–í—ã—Ä—É—á–∫–∞'] = df_sales_2023_2025['–í—ã—Ä—É—á–∫–∞'].fillna(0).round(0).astype(int)

# 8. –ê–ª–∏–∞—Å –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
df_sales = df_sales_2023_2025
print('UI Skipped: ' + str(df_sales_2023_2025.head()))

print(f"–ü–æ—Å–ª–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –∏ –º–µ—Ä–¥–∂–µ–π: –í—Å–µ–≥–æ —Å—Ç—Ä–æ–∫ {len(df_sales_2023_2025)}")
print(f"–ü–æ—Å–ª–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –∏ –º–µ—Ä–¥–∂–µ–π: –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–æ–º–±–∏–Ω–∞—Ü–∏–π {len(df_sales_2023_2025.drop_duplicates(subset=['–§–∏–ª–∏–∞–ª', '–û—Ç–¥–µ–ª', '–ì–æ–¥', '–ú–µ—Å—è—Ü']))}")

import numpy as np

# –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏ '–í—ã—Ä—É—á–∫–∞' –≤ —á–∏—Å–ª–æ–≤–æ–π —Ç–∏–ø (–∑–∞–º–µ–Ω–∞ –∑–∞–ø—è—Ç–æ–π –Ω–∞ —Ç–æ—á–∫—É)
# –°–Ω–∞—á–∞–ª–∞ –ø—Ä–∏–≤–æ–¥–∏–º –∫ —Å—Ç—Ä–æ–∫–µ, —á—Ç–æ–±—ã –º–µ—Ç–æ–¥ .str —Ä–∞–±–æ—Ç–∞–ª –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –∑–∞—Ç–µ–º –∑–∞–º–µ–Ω—è–µ–º –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º
df_sales_2023_2025['–í—ã—Ä—É—á–∫–∞'] = df_sales_2023_2025['–í—ã—Ä—É—á–∫–∞'].astype(str).str.replace(',', '.').astype(float)

# –†–∞—Å—á–µ—Ç –∫–æ–ª–æ–Ω–∫–∏ '–°—Ä–µ–¥–Ω–∏–π –ß–µ–∫'
df_sales_2023_2025['–°—Ä–µ–¥–Ω–∏–π –ß–µ–∫'] = df_sales_2023_2025['–í—ã—Ä—É—á–∫–∞'] / df_sales_2023_2025['–ß–µ–∫–∏']

# –ó–∞–º–µ–Ω–∞ –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π (inf) –∏ –ø—É—Å—Ç—ã—Ö (NaN) –Ω–∞ 0 –¥–ª—è –°—Ä–µ–¥–Ω–µ–≥–æ –ß–µ–∫–∞
df_sales_2023_2025['–°—Ä–µ–¥–Ω–∏–π –ß–µ–∫'] = df_sales_2023_2025['–°—Ä–µ–¥–Ω–∏–π –ß–µ–∫'].replace([np.inf, -np.inf], 0).fillna(0)

# –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ –°—Ä–µ–¥–Ω–µ–≥–æ –ß–µ–∫–∞ –¥–æ —Ü–µ–ª–æ–≥–æ
df_sales_2023_2025['–°—Ä–µ–¥–Ω–∏–π –ß–µ–∫'] = df_sales_2023_2025['–°—Ä–µ–¥–Ω–∏–π –ß–µ–∫'].round(0).astype(int)

# –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ –í—ã—Ä—É—á–∫–∏ –¥–æ —Ü–µ–ª–æ–≥–æ (—Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –ø—É—Å—Ç—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π)
df_sales_2023_2025['–í—ã—Ä—É—á–∫–∞'] = df_sales_2023_2025['–í—ã—Ä—É—á–∫–∞'].fillna(0).round(0).astype(int)

# –í—ã–≤–æ–¥ –ø–µ—Ä–≤—ã—Ö —Å—Ç—Ä–æ–∫ —Å –Ω–æ–≤–æ–π –∫–æ–ª–æ–Ω–∫–æ–π
print('UI Skipped: ' + str(df_sales_2023_2025.head()))

# @title –ü–ª–æ—â–∞–¥–∏ –º–∞–≥–∞–∑–∏–Ω–æ–≤
# ID —Ç—Ä–µ—Ç—å–µ–π —Ç–∞–±–ª–∏—Ü—ã
area_sheet_id = '1yPANhEDRwf_CKMLLz5Wdov4Tx8HCgfS0ckyW7jv1ugQ'
# –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
area_url = f'https://docs.google.com/spreadsheets/d/{area_sheet_id}/export?format=csv'

# –ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ DataFrame
df_area = pd.read_csv(area_url)

# –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ (unpivot) —Ç–∞–±–ª–∏—Ü—ã: —Ñ–∏–ª–∏–∞–ª—ã –∏–∑ –∫–æ–ª–æ–Ω–æ–∫ –ø–µ—Ä–µ–Ω–æ—Å–∏–º –≤ —Å—Ç—Ä–æ–∫–∏
df_area = df_area.melt(id_vars=['–ì–æ–¥', '–ú–µ—Å—è—Ü', '–û—Ç–¥–µ–ª'], var_name='–§–∏–ª–∏–∞–ª', value_name='–ü–ª–æ—â–∞–¥—å')

# --- –î–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (2023-2026) ---
# –°–ø–∏—Å–æ–∫ –º–µ—Å—è—Ü–µ–≤ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
months_order = ['—è–Ω–≤', '—Ñ–µ–≤', '–º–∞—Ä', '–∞–ø—Ä', '–º–∞–π', '–∏—é–Ω', '–∏—é–ª', '–∞–≤–≥', '—Å–µ–Ω', '–æ–∫—Ç', '–Ω–æ—è', '–¥–µ–∫']
month_map = {m: i+1 for i, m in enumerate(months_order)}

# –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
branches = df_area['–§–∏–ª–∏–∞–ª'].unique()
departments = df_area['–û—Ç–¥–µ–ª'].unique()
years = [2023, 2024, 2025, 2026]

# –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª–Ω–æ–π —Å–µ—Ç–∫–∏ (Grid) –≤—Å–µ—Ö –∫–æ–º–±–∏–Ω–∞—Ü–∏–π: –§–∏–ª–∏–∞–ª * –û—Ç–¥–µ–ª * –ì–æ–¥ * –ú–µ—Å—è—Ü
# –ò—Å–ø–æ–ª—å–∑—É–µ–º MultiIndex –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
index = pd.MultiIndex.from_product([branches, departments, years, months_order], names=['–§–∏–ª–∏–∞–ª', '–û—Ç–¥–µ–ª', '–ì–æ–¥', '–ú–µ—Å—è—Ü'])
df_full = pd.DataFrame(index=index).reset_index()

# –î–æ–±–∞–≤–ª—è–µ–º —á–∏—Å–ª–æ–≤–æ–π –Ω–æ–º–µ—Ä –º–µ—Å—è—Ü–∞ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
df_full['Month_Num'] = df_full['–ú–µ—Å—è—Ü'].map(month_map)

# –û–±—ä–µ–¥–∏–Ω—è–µ–º —Å –∏—Å—Ö–æ–¥–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
df_merged = pd.merge(df_full, df_area, on=['–§–∏–ª–∏–∞–ª', '–û—Ç–¥–µ–ª', '–ì–æ–¥', '–ú–µ—Å—è—Ü'], how='left')

# –°–æ—Ä—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è (–ø–æ –≤—Ä–µ–º–µ–Ω–∏)
df_merged = df_merged.sort_values(by=['–§–∏–ª–∏–∞–ª', '–û—Ç–¥–µ–ª', '–ì–æ–¥', 'Month_Num'])

# –ó–∞–ø–æ–ª–Ω—è–µ–º –ø—Ä–æ–ø—É—Å–∫–∏ –º–µ—Ç–æ–¥–æ–º forward fill (–ø—Ä–æ—Ç—è–≥–∏–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ –∏–∑–≤–µ—Å—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ)
df_merged['–ü–ª–æ—â–∞–¥—å'] = df_merged.groupby(['–§–∏–ª–∏–∞–ª', '–û—Ç–¥–µ–ª'])['–ü–ª–æ—â–∞–¥—å'].ffill()

# --- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö ---
# –û—Å—Ç–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–æ–ª—å–∫–æ –Ω–∞—á–∏–Ω–∞—è —Å 2024 –≥–æ–¥–∞
df_merged = df_merged[df_merged['–ì–æ–¥'] >= 2024]

# –û—Å—Ç–∞–≤–ª—è–µ–º –Ω—É–∂–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
df_area = df_merged[['–§–∏–ª–∏–∞–ª', '–û—Ç–¥–µ–ª', '–ú–µ—Å—è—Ü', '–ì–æ–¥', '–ü–ª–æ—â–∞–¥—å']]

# –í—ã–≤–æ–¥ –ø–µ—Ä–≤—ã—Ö —Å—Ç—Ä–æ–∫ –∏ –ø—Ä–∏–º–µ—Ä–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –¥–ª—è 2026 –≥–æ–¥–∞
print("–ü–µ—Ä–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ (2024 –≥–æ–¥):")
print('UI Skipped: ' + str(df_area.head()))
print("\n–ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö –∑–∞ 2026 –≥–æ–¥ (–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ):")
print('UI Skipped: ' + str(df_area[df_area['–ì–æ–¥'] == 2026].head()))

# --- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø–ª–æ—â–∞–¥–µ–π –¥–ª—è 2024 –∏ 2025 –≥–æ–¥–∞ ---
print("\n--- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø–ª–æ—â–∞–¥–µ–π (2024-2025) ---")

df_check_area = df_area[(df_area['–ì–æ–¥'] >= 2024) & (df_area['–ì–æ–¥'] <= 2025)].copy()

# –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –º–µ—Å—è—Ü–µ–≤
missing_area_entries = df_check_area[(df_check_area['–ü–ª–æ—â–∞–¥—å'].isnull()) | (df_check_area['–ü–ª–æ—â–∞–¥—å'] == 0)]

if not missing_area_entries.empty:
    print(f"‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –Ω–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏–ª–∏ –Ω—É–ª–µ–≤—ã–µ –ø–ª–æ—â–∞–¥–∏ –≤ 2024-2025 –≥–æ–¥–∞—Ö ({len(missing_area_entries)} –∑–∞–ø–∏—Å–µ–π):")
    print('UI Skipped: ' + str(missing_area_entries))
else:
    print("‚úÖ –í—Å–µ –º–µ—Å—è—Ü—ã –≤ 2024 –∏ 2025 –≥–æ–¥–∞—Ö –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –¥–∞–Ω–Ω—ã–º–∏ –ø–æ –ø–ª–æ—â–∞–¥—è–º (–∑–Ω–∞—á–µ–Ω–∏—è > 0).")

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å–≤–æ–¥–∫–∞ –ø–æ –≥–æ–¥–∞–º
summary_2024_2025 = df_check_area.groupby('–ì–æ–¥')['–ü–ª–æ—â–∞–¥—å'].apply(lambda x: (x > 0).sum()).reset_index()
summary_2024_2025.columns = ['–ì–æ–¥', '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ_–∑–∞–ø–∏—Å–µ–π_—Å_–ø–ª–æ—â–∞–¥—å—é_>_0']

total_entries_2024_2025 = df_check_area.groupby('–ì–æ–¥').size().reset_index(name='–û–±—â–µ–µ_–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ_–∑–∞–ø–∏—Å–µ–π')

summary_final = pd.merge(total_entries_2024_2025, summary_2024_2025, on='–ì–æ–¥', how='left')
summary_final['–ü—Ä–æ—Ü–µ–Ω—Ç_–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è'] = (summary_final['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ_–∑–∞–ø–∏—Å–µ–π_—Å_–ø–ª–æ—â–∞–¥—å—é_>_0'] / summary_final['–û–±—â–µ–µ_–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ_–∑–∞–ø–∏—Å–µ–π']) * 100

print("\n–°–≤–æ–¥–∫–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø–ª–æ—â–∞–¥–µ–π –ø–æ 2024 –∏ 2025 –≥–æ–¥–∞–º:")
print('UI Skipped: ' + str(summary_final))

# --- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è –¢–∞–º–±–æ–≤–∞ (2024-2025) ---
print("\n--- –°—É–º–º–∞—Ä–Ω—ã–µ –ø–ª–æ—â–∞–¥–∏ –¥–ª—è —Ñ–∏–ª–∏–∞–ª–∞ '–¢–∞–º–±–æ–≤' (2024-2025) ---")

df_tambov_area = df_area[
    (df_area['–§–∏–ª–∏–∞–ª'] == '–¢–∞–º–±–æ–≤') &
    (df_area['–ì–æ–¥'].isin([2024, 2025]))
].copy()

# –î–æ–±–∞–≤–ª—è–µ–º —á–∏—Å–ª–æ–≤–æ–π –Ω–æ–º–µ—Ä –º–µ—Å—è—Ü–∞ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
df_tambov_area['Month_Num'] = df_tambov_area['–ú–µ—Å—è—Ü'].map(month_map)

# –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –≥–æ–¥—É –∏ –º–µ—Å—è—Ü—É, —Å—É–º–º–∏—Ä—É–µ–º –ø–ª–æ—â–∞–¥–∏
summary_tambov_area = df_tambov_area.groupby(['–ì–æ–¥', '–ú–µ—Å—è—Ü', 'Month_Num'])['–ü–ª–æ—â–∞–¥—å'].sum().reset_index()

# –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≥–æ–¥—É –∏ –Ω–æ–º–µ—Ä—É –º–µ—Å—è—Ü–∞
summary_tambov_area = summary_tambov_area.sort_values(by=['–ì–æ–¥', 'Month_Num'])

# –£–±–∏—Ä–∞–µ–º –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—É—é –∫–æ–ª–æ–Ω–∫—É
summary_tambov_area = summary_tambov_area[['–ì–æ–¥', '–ú–µ—Å—è—Ü', '–ü–ª–æ—â–∞–¥—å']]

# –í—ã–≤–æ–¥–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
print('UI Skipped: ' + str(summary_tambov_area))

# --- –ò—Ç–æ–≥–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Å –ø–ª–æ—â–∞–¥—è–º–∏ –ø–æ –≤—Å–µ–º —Ñ–∏–ª–∏–∞–ª–∞–º, –æ—Ç–¥–µ–ª–∞–º –∏ –º–µ—Å—è—Ü–∞–º ---
print("\n--- –ò—Ç–æ–≥–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø–ª–æ—â–∞–¥–µ–π –ø–æ—Å–ª–µ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è (–≤—Å–µ —Ñ–∏–ª–∏–∞–ª—ã –∏ –æ—Ç–¥–µ–ª—ã) ---")
print('UI Skipped: ' + str(df_area))

# @title –ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–¥–∞–∂
# ID —Ç–∞–±–ª–∏—Ü—ã –∏ GID (–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ª–∏—Å—Ç–∞)
new_sheet_id = '1yPANhEDRwf_CKMLLz5Wdov4Tx8HCgfS0ckyW7jv1ugQ'
gid = '2130598218'

# –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ª–∏—Å—Ç–∞
new_url = f'https://docs.google.com/spreadsheets/d/{new_sheet_id}/export?format=csv&gid={gid}'

# –ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ DataFrame
df_rules_structure = pd.read_csv(new_url)

# –î–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
df_new_table = df_rules_structure

# –í—ã–≤–æ–¥ –ø–µ—Ä–≤—ã—Ö —Å—Ç—Ä–æ–∫
print('UI Skipped: ' + str(df_rules_structure.head()))

# @title –§–æ—Ä–º–∞—Ç—ã –º–∞–≥–∞–∑–∏–Ω–æ–≤
# –°–ª–æ–≤–∞—Ä—å –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏–π –º–µ—Å—è—Ü–µ–≤
month_map = {'—è–Ω–≤': 1, '—Ñ–µ–≤': 2, '–º–∞—Ä': 3, '–∞–ø—Ä': 4, '–º–∞–π': 5, '–∏—é–Ω': 6, '–∏—é–ª': 7, '–∞–≤–≥': 8, '—Å–µ–Ω': 9, '–æ–∫—Ç': 10, '–Ω–æ—è': 11, '–¥–µ–∫': 12}

try:
    # --- –°–æ–∑–¥–∞–Ω–∏–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ —Ñ–æ—Ä–º–∞—Ç–æ–≤ ---
    data_formats = {
        '–§–∏–ª–∏–∞–ª': [
            '–í–æ–ª–æ–≥–¥–∞ –¢–¶', '–ò–≤–∞–Ω–æ–≤–æ', '–Ø—Ä–æ—Å–ª–∞–≤–ª—å', '–ö–æ—Å—Ç—Ä–æ–º–∞ –°—Ç—Ä–æ–π–∫–∞', '–Ø—Ä–æ—Å–ª–∞–≤–ª—å–§—Ä—É–Ω–∑–µ',
            '–ß–µ—Ä–µ–ø–æ–≤–µ—Ü –¢–¶', '–†—ã–±–∏–Ω—Å–∫', '–¢–∞–º–±–æ–≤', '–í–ª–∞–¥–∏–º–∏—Ä –†–æ–∑–Ω–∏—Ü–∞', '–í–ª–∞–¥–∏–º–∏—Ä –õ–µ–Ω—Ç–∞',
            '–í–æ—Ä–æ–Ω–µ–∂', '–í–æ—Ä–æ–Ω–µ–∂ –ú–æ—Å–∫–æ–≤—Å–∫–∏–π –ü—Ä–æ—Å–ø–µ–∫—Ç', '–ú–æ—Å–∫–≤–∞ –•–∞–±'
        ],
        '–§–æ—Ä–º–∞—Ç': [
            '–§–ª–∞–≥–º–∞–Ω', '–§–ª–∞–≥–º–∞–Ω', '–°—Ä–µ–¥–Ω–∏–π', '–°—Ä–µ–¥–Ω–∏–π', '–°—Ä–µ–¥–Ω–∏–π',
            '–°—Ä–µ–¥–Ω–∏–π', '–°—Ä–µ–¥–Ω–∏–π', '–°—Ä–µ–¥–Ω–∏–π', '–ú–∏–Ω–∏', '–ú–∏–Ω–∏',
            '–ú–∏–∫—Ä–æ', '–ú–∏–∫—Ä–æ', '–ò–Ω—Ç–µ—Ä–Ω–µ—Ç'
        ]
    }
    df_formats = pd.DataFrame(data_formats)

    # --- –ê–Ω–∞–ª–∏–∑ —Å—Ç–∞—Ä—Ç–∞ –ø—Ä–æ–¥–∞–∂ ---
    # –°–æ–∑–¥–∞–µ–º –∫–æ–ø–∏—é –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
    df_temp = df_sales_2023_2025.copy()

    # –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞—Ç—É –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
    df_temp['Month_Num'] = df_temp['–ú–µ—Å—è—Ü'].map(month_map)
    df_temp['Date'] = pd.to_datetime(df_temp['–ì–æ–¥'].astype(str) + '-' + df_temp['Month_Num'].astype(str) + '-01')

    # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ (–æ—Ç —Ä–∞–Ω–Ω–µ–π –∫ –ø–æ–∑–¥–Ω–µ–π)
    df_temp = df_temp.sort_values('Date')

    # –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—É—é –∑–∞–ø–∏—Å—å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∏–ª–∏–∞–ª–∞
    df_start_sales = df_temp.drop_duplicates(subset=['–§–∏–ª–∏–∞–ª'], keep='first')[['–§–∏–ª–∏–∞–ª', '–ú–µ—Å—è—Ü', '–ì–æ–¥']]

    # –ü–µ—Ä–µ–∏–º–µ–Ω—É–µ–º –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏
    df_start_sales = df_start_sales.rename(columns={'–ú–µ—Å—è—Ü': '–ü–µ—Ä–≤—ã–π –ú–µ—Å—è—Ü', '–ì–æ–¥': '–ü–µ—Ä–≤—ã–π –ì–æ–¥'})

    # –û–±—ä–µ–¥–∏–Ω—è–µ–º —Å –¥–∞–Ω–Ω—ã–º–∏ –æ —Ñ–æ—Ä–º–∞—Ç–∞—Ö
    df_store_formats = pd.merge(df_start_sales, df_formats, on='–§–∏–ª–∏–∞–ª', how='left')

    # –í—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    print("–§–æ—Ä–º–∞—Ç—ã –º–∞–≥–∞–∑–∏–Ω–æ–≤:")
    print('UI Skipped: ' + str(df_store_formats.reset_index(drop=True)))

except NameError:
    print("‚ö†Ô∏è –û—à–∏–±–∫–∞: –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è 'df_sales_2023_2025' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
    print("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –≤—ã–ø–æ–ª–Ω–∏–ª–∏ —è—á–µ–π–∫–∏ —Å –∑–∞–≥—Ä—É–∑–∫–æ–π –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–æ–π –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–æ–¥–∞–∂–∞—Ö (–ü—Ä–æ–¥–∞–∂–∏ 2023-2025) –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —ç—Ç–æ–π —è—á–µ–π–∫–∏.")

# @title üîç –ì–ª—É–±–æ–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ (Audit)
# --- 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –°–´–†–´–• –¥–∞–Ω–Ω—ã—Ö (–∏–∑ —Ñ–∞–π–ª–∞) ---
print("--- 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ò–°–•–û–î–ù–´–• –¥–∞–Ω–Ω—ã—Ö (–∏–∑ —Ñ–∞–π–ª–∞) ---")
raw_check = pd.read_csv(sales_url)

# –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è
raw_check['–í—ã—Ä—É—á–∫–∞_Clean'] = raw_check['–í—ã—Ä—É—á–∫–∞'].astype(str).str.replace(r'\s+', '', regex=True).str.replace(',', '.')
raw_check['–í—ã—Ä—É—á–∫–∞_Clean'] = pd.to_numeric(raw_check['–í—ã—Ä—É—á–∫–∞_Clean'], errors='coerce')
raw_check['–§–∏–ª–∏–∞–ª'] = raw_check['–§–∏–ª–∏–∞–ª'].astype(str).str.strip()
raw_check['–û—Ç–¥–µ–ª'] = raw_check['–û—Ç–¥–µ–ª'].astype(str).str.strip()
raw_check['–ú–µ—Å—è—Ü'] = raw_check['–ú–µ—Å—è—Ü'].astype(str).str.strip()

# –§–∏–ª—å—Ç—Ä 2024-2025
raw_check = raw_check[raw_check['–ì–æ–¥'].isin([2024, 2025])]

# –ü–æ–ª–Ω—ã–µ –¥—É–±–ª–∏–∫–∞—Ç—ã (–≤–∫–ª—é—á–∞—è —Å—É–º–º—É)
full_dupes = raw_check[raw_check.duplicated(subset=['–§–∏–ª–∏–∞–ª', '–û—Ç–¥–µ–ª', '–ì–æ–¥', '–ú–µ—Å—è—Ü', '–í—ã—Ä—É—á–∫–∞_Clean'], keep=False)]
print(f"–ü–æ–ª–Ω—ã—Ö –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –≤ –∏—Å—Ö–æ–¥–Ω–∏–∫–µ: {len(full_dupes)}")

if len(full_dupes) > 0:
    print('UI Skipped: ' + str(full_dupes.head()))
else:
    print("‚úÖ –í –∏—Å—Ö–æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ –ø–æ–ª–Ω—ã—Ö –¥—É–±–ª–µ–π –Ω–µ—Ç.")

# --- 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –û–ë–†–ê–ë–û–¢–ê–ù–ù–´–• –¥–∞–Ω–Ω—ã—Ö (df_sales_2023_2025) ---
print("\n--- 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –û–ë–†–ê–ë–û–¢–ê–ù–ù–´–• –¥–∞–Ω–Ω—ã—Ö (–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –≤ —Ä–∞—Å—á–µ—Ç–µ) ---")
try:
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –∫–ª—é—á–µ–π
    processed_dupes = df_sales_2023_2025[df_sales_2023_2025.duplicated(subset=['–§–∏–ª–∏–∞–ª', '–û—Ç–¥–µ–ª', '–ì–æ–¥', '–ú–µ—Å—è—Ü'], keep=False)]
    print(f"–î—É–±–ª–∏–∫–∞—Ç–æ–≤ –∫–ª—é—á–µ–π –≤ –∏—Ç–æ–≥–æ–≤–æ–π —Ç–∞–±–ª–∏—Ü–µ: {len(processed_dupes)}")

    if len(processed_dupes) > 0:
        print("‚ö†Ô∏è –ù–∞–π–¥–µ–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫ –≤ –∏—Ç–æ–≥–æ–≤–æ–π —Ç–∞–±–ª–∏—Ü–µ!")
        print('UI Skipped: ' + str(processed_dupes.sort_values(['–§–∏–ª–∏–∞–ª', '–û—Ç–¥–µ–ª', '–ì–æ–¥', '–ú–µ—Å—è—Ü']).head()))
    else:
        print("‚úÖ –ò—Ç–æ–≥–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ —á–∏—Å—Ç–∞: –∫–∞–∂–¥–∞—è –∫–æ–º–±–∏–Ω–∞—Ü–∏—è (–§–∏–ª–∏–∞–ª+–û—Ç–¥–µ–ª+–ì–æ–¥+–ú–µ—Å—è—Ü) —É–Ω–∏–∫–∞–ª—å–Ω–∞.")

    # –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø—Ä–∏–º–µ—Ä
    print("\n–ü—Ä–∏–º–µ—Ä: –Ø—Ä–æ—Å–ª–∞–≤–ª—å / –ö—Ä–∞—Å–∫–∏ / –∏—é–ª 2025:")
    example = df_sales_2023_2025[
        (df_sales_2023_2025['–§–∏–ª–∏–∞–ª'] == '–Ø—Ä–æ—Å–ª–∞–≤–ª—å') &
        (df_sales_2023_2025['–û—Ç–¥–µ–ª'] == '8. –ö—Ä–∞—Å–∫–∏') &
        (df_sales_2023_2025['–ì–æ–¥'] == 2025) &
        (df_sales_2023_2025['–ú–µ—Å—è—Ü'] == '–∏—é–ª')
    ]
    print('UI Skipped: ' + str(example))

except NameError:
    print("‚ö†Ô∏è –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è df_sales_2023_2025 –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–¥ —Ä–∞—Å—á–µ—Ç–∞.")

import pandas as pd

# ID —Ç–∞–±–ª–∏—Ü—ã –∏ GID –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–∏
sheet_id_new = '1q_hU5hQJ2aQXadGKJak2BY2DWltGTrhpi_7UyRVbXVM'
gid_new = '358837029'
url_new = f'https://docs.google.com/spreadsheets/d/{sheet_id_new}/export?format=csv&gid={gid_new}'

# –ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
df_raw_new = pd.read_csv(url_new)

print("–ò—Å—Ö–æ–¥–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏:", df_raw_new.columns.tolist())
print('UI Skipped: ' + str(df_raw_new.head()))

# --- Local Storage Setup ---
import json
import os

DATA_DIR = 'data'
if not os.path.exists(DATA_DIR):
    os.makedirs(DATA_DIR)

# Dummy credentials object to avoid breaking code that expects it, though we'll ignore it
creds = None
gc = None

from datetime import datetime
import pandas as pd

# –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ –ø–ª–æ—Å–∫—É—é —Ç–∞–±–ª–∏—Ü—É
# –û–ø—Ä–µ–¥–µ–ª—è–µ–º id_vars (–∫–æ–ª–æ–Ω–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –ù–ï —è–≤–ª—è—é—Ç—Å—è –º–µ—Å—è—Ü–∞–º–∏)
id_vars = [col for col in df_raw_new.columns if col in ['–û—Ç–¥–µ–ª', '–§–∏–ª–∏–∞–ª']]

# –ï—Å–ª–∏ –Ω—É–∂–Ω—ã—Ö –∫–æ–ª–æ–Ω–æ–∫ –Ω–µ—Ç, –ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–æ—Ö–æ–∂–∏–µ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å–µ –Ω–µ-–º–µ—Å—è—Ü—ã
if not id_vars:
    id_vars = df_raw_new.columns[:2].tolist()

df_flat = df_raw_new.melt(
    id_vars=id_vars,
    var_name='–ú–µ—Å—è—Ü',
    value_name='–í—ã—Ä—É—á–∫–∞'
)

# 1. –û—á–∏—Å—Ç–∫–∞ –∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –í—ã—Ä—É—á–∫–∏ –≤ —á–∏—Å–ª–æ (—É–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã)
df_flat['–í—ã—Ä—É—á–∫–∞'] = df_flat['–í—ã—Ä—É—á–∫–∞'].astype(str).str.replace(r'\s+', '', regex=True).str.replace(',', '.')
df_flat['–í—ã—Ä—É—á–∫–∞'] = pd.to_numeric(df_flat['–í—ã—Ä—É—á–∫–∞'], errors='coerce')

# 2. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –ø–æ–¥ "–¢–∞–±–ª–∏—Ü—É –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–æ–∫"
# –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –í—ã—Ä—É—á–∫–∞ -> –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞
df_flat = df_flat.rename(columns={'–í—ã—Ä—É—á–∫–∞': '–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞'})

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏
df_flat['–î–∞—Ç–∞'] = datetime.now().strftime('%Y-%m-%d %H:%M:%S')

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—É—Å—Ç–æ–π –∫–æ–ª–æ–Ω–∫–∏ –ö–æ—Ä—Ä_–î–µ–ª—å—Ç–∞
df_flat['–ö–æ—Ä—Ä_–î–µ–ª—å—Ç–∞'] = None

# –£–ø–æ—Ä—è–¥–æ—á–∏–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–æ–∫: –§–∏–ª–∏–∞–ª | –û—Ç–¥–µ–ª | –ú–µ—Å—è—Ü | –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ | –ö–æ—Ä—Ä_–î–µ–ª—å—Ç–∞ | –î–∞—Ç–∞
export_cols = ['–§–∏–ª–∏–∞–ª', '–û—Ç–¥–µ–ª', '–ú–µ—Å—è—Ü', '–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞', '–ö–æ—Ä—Ä_–î–µ–ª—å—Ç–∞', '–î–∞—Ç–∞']

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –≤—Å–µ—Ö –∫–æ–ª–æ–Ω–æ–∫, –¥–æ–±–∞–≤–ª—è–µ–º –µ—Å–ª–∏ –Ω–µ—Ç
for col in export_cols:
    if col not in df_flat.columns:
        df_flat[col] = None

# –ò—Ç–æ–≥–æ–≤–∞—è –≤—ã–±–æ—Ä–∫–∞ –≤ –Ω—É–∂–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
df_export = df_flat[export_cols]

print(f"–ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ –∫ –≤—ã–≥—Ä—É–∑–∫–µ: {len(df_export)} —Å—Ç—Ä–æ–∫")
print('UI Skipped: ' + str(df_export.head()))

# --- –≠–∫—Å–ø–æ—Ä—Ç –≤ Google Sheets ---
export_sheet_id = '1q_hU5hQJ2aQXadGKJak2BY2DWltGTrhpi_7UyRVbXVM'
export_gid = '1311408195'

try:
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π gc, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å, –∏–Ω–∞—á–µ –∞–≤—Ç–æ—Ä–∏–∑—É–µ–º—Å—è
    if 'gc' not in globals() or gc is None:
        # from google.colab import auth
        # from google.auth import default
        # import gspread
        pass # auth.authenticate_user()
        creds = None
        gc = None

    sh = gc.open_by_key(export_sheet_id) if gc else None
    # –ü–æ–∏—Å–∫ –≤–∫–ª–∞–¥–∫–∏ –ø–æ GID
    ws = next((w for w in sh.worksheets() if str(w.id) == export_gid), None) if sh else None

    if ws:
        ws.clear()
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö: –∑–∞–≥–æ–ª–æ–≤–∫–∏ + —Å—Ç—Ä–æ–∫–∏
        # fillna('') –∑–∞–º–µ–Ω—è–µ—Ç –ø—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏
        data_to_export = [df_export.columns.tolist()] + df_export.fillna('').astype(str).values.tolist()

        # –ó–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö –Ω–∞—á–∏–Ω–∞—è —Å —è—á–µ–π–∫–∏ A1
        ws.update('A1', data_to_export)
        print(f"‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –≤—ã–≥—Ä—É–∂–µ–Ω—ã –≤–æ –≤–∫–ª–∞–¥–∫—É: {ws.title} (GID: {export_gid})")
    else:
        print(f"‚ùå –í–∫–ª–∞–¥–∫–∞ —Å GID {export_gid} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ.")

except Exception as e:
    print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–≥—Ä—É–∑–∫–µ: {e}")


print("--- SAVING V4 ---")
target_df = None
if 'df_result' in locals():
    target_df = df_result
    print("Found df_result")
elif 'df_app' in locals():
    target_df = df_app
    print("Found df_app")
elif 'df_sales_2023_2025' in locals():
    target_df = df_sales_2023_2025
    print("Found df_sales_2023_2025 as fallback")

if target_df is not None:
    # Ensure Month/Year int
    try:
        if '–ú–µ—Å—è—Ü' in target_df.columns: target_df['–ú–µ—Å—è—Ü'] = target_df['–ú–µ—Å—è—Ü'].astype(int)
        if '–ì–æ–¥' in target_df.columns: target_df['–ì–æ–¥'] = target_df['–ì–æ–¥'].astype(int)
    except: pass
    
    target_df.to_csv('/home/eveselove/PLAN/dashboard_data.csv', index=False)
    
    # Save pkl for compatibility logic (optional)
    try:
        with open('/home/eveselove/PLAN/dashboard_data.pkl', 'wb') as f:
            pickle.dump({'df_result': target_df, 'df_roles': None}, f)
        print("‚úÖ Saved dashboard_data.pkl (new version)")
    except Exception as e:
        print(f"Pkl error: {e}")
        
    print("‚úÖ Saved dashboard_data.csv")
else:
    print("‚ùå No DataFrame found!")
